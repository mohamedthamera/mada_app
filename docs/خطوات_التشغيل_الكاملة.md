# ما المطلوب منك تفعيله — خطوة بخطوة

هذا الملف يلخّص **كل الخطوات** التي تحتاج تنفيذها بالترتيب حتى يعمل التطبيق + لوحة الأدمن + أكواد المؤثرين + ربط الجهاز الواحد والحظر.

---

## الجزء ١ — Supabase (قاعدة البيانات والصلاحيات)

### ١.١ الحصول على بيانات المشروع

1. ادخل إلى **https://supabase.com/dashboard** وسجّل الدخول.
2. اختر مشروعك (مثلاً **mada_app**).
3. من القائمة اليسرى: **Project Settings** (أيقونة الترس) → **API**.
4. انسخ واحفظ:
   - **Project URL** (مثل `https://wzbaedyivgosgduvpgjg.supabase.co`)
   - **anon public** (مفتاح الـ API العام)

ستحتاجها في ملفات `.env` للتطبيق واللوحة.

---

### ١.٢ تطبيق الهجرات (Migrations) على قاعدة البيانات

يجب أن تكون جداول ودوال قاعدة البيانات موجودة. لديك خياران:

**الطريقة الأولى — من الطرفية (الأسهل):**

1. افتح **Terminal**.
2. انتقل لمجلد المشروع:
   ```bash
   cd /Users/mohammedthamer/Desktop/mada_app
   ```
3. اربط المشروع بـ Supabase (مرة واحدة فقط):
   ```bash
   npx supabase link --project-ref wzbaedyivgosgduvpgjg
   ```
   (استبدل `wzbaedyivgosgduvpgjg` بـ **مرجع مشروعك** من Project Settings → General → Reference ID إن كان مختلفاً.)
4. طبّق كل الهجرات:
   ```bash
   npx supabase db push
   ```
   ستُطبَّق تلقائياً فقط الملفات التي لم تُطبَّق من قبل (بما فيها 028 و 029).

**الطريقة الثانية — من لوحة Supabase (SQL Editor):**

1. من لوحة Supabase: **SQL Editor** → **New query**.
2. إذا لم تكن قد طبّقت الهجرات من قبل، نفّذ الملفات بالترتيب من:
   `supabase/migrations/001_init.sql`
   حتى
   `supabase/migrations/029_single_device_and_ban.sql`
   (انسخ محتوى كل ملف والصقه في الاستعلام ثم **Run**).
3. المهم أن تكون **028** (أكواد المؤثرين) و **029** (جهاز واحد وحظر) مطبَّقة.

بعد هذا تكون الجداول مثل `influencers`, `user_referrals`, `profiles` (مع أعمدة الجهاز والحظر) وجميع الدوال (مثل `apply_referral_code`, `check_device_or_register`) جاهزة.

---

### ١.٣ صلاحية الأدمن (لتسجيل الدخول للوحة الأدمن وتوليد الأكواد وأكواد المؤثرين)

1. من Supabase: **SQL Editor** → **New query**.
2. إذا لم تكن قد نفذت migration **024** من قبل، نفّذ محتوى الملف:
   `supabase/migrations/024_set_admin_by_email.sql`
   (نسخ ولصق ثم Run).
3. نفّذ الاستعلام التالي بعد استبدال البريد ببريدك الذي ستسجّل به في لوحة الأدمن:
   ```sql
   select set_admin_by_email('your@email.com');
   ```
4. يجب أن تظهر رسالة تؤكد تعيين الأدمن.

بدلاً من ذلك يمكنك يدوياً من **Table Editor** → **profiles**: عدّل عمود **role** إلى `admin` للصف الخاص بحسابك (نفس **id** المستخدم من **Authentication** → **Users**).

---

### ١.٤ أكواد المؤثرين في لوحة الأدمن

صفحة **أكواد المؤثرين** تعمل عبر دوال RPC في قاعدة البيانات (لا تحتاج نشر Edge Function). يكفي تطبيق الهجرات:

- **028** (جداول المؤثرين والإحالة)
- **030** (دوال الأدمن: `admin_influencer_list`, `admin_influencer_create`, إلخ)

إذا نفذت `npx supabase db push` في ١.٢ فالهجرتان ستُطبَّقان تلقائياً. بعدها ادخل إلى لوحة الأدمن بحساب له `role = admin` وافتح «أكواد المؤثرين».

---

## الجزء ٢ — تشغيل لوحة الأدمن (ويب)

1. تأكد أن في مجلد **apps/admin** يوجد ملف بيئة يحتوي على بيانات Supabase، مثلاً:
   - **.env** أو **.env.dev** أو **.env.prod**
   وفيها على الأقل:
   ```env
   SUPABASE_URL=https://wzbaedyivgosgduvpgjg.supabase.co
   SUPABASE_ANON_KEY=المفتاح_العام_anon
   ```
   (استخدم نفس القيم من ١.١.)
2. من الطرفية:
   ```bash
   cd /Users/mohammedthamer/Desktop/mada_app/apps/admin
   flutter pub get
   flutter run -d chrome
   ```
3. يفتح المتصفح على لوحة الأدمن. سجّل الدخول **بنفس البريد الذي عيّنته أدمناً** في ١.٣.
4. بعد الدخول يمكنك:
   - توليد أكواد الاشتراك الدائم (من قسم الاشتراكات).
   - إدارة أكواد المؤثرين من قسم **أكواد المؤثرين** (بعد تنفيذ ١.٤).

---

## الجزء ٣ — تشغيل تطبيق الموبايل

1. تأكد أن في **apps/mobile** ملف بيئة (مثل **.env** أو **.env.dev**) يحتوي:
   ```env
   SUPABASE_URL=https://wzbaedyivgosgduvpgjg.supabase.co
   SUPABASE_ANON_KEY=المفتاح_العام_anon
   ```
2. من الطرفية:
   ```bash
   cd /Users/mohammedthamer/Desktop/mada_app/apps/mobile
   flutter pub get
   flutter run -d chrome
   ```
   أو لتشغيل على محاكي آيفون:
   ```bash
   flutter run -d "iPhone 16e"
   ```
   أو أندرويد:
   ```bash
   flutter run -d <device_id>
   ```
3. في التطبيق يمكنك التسجيل/تسجيل الدخول، وإدخال كود الإحالة (من الملف الشخصي أو عند التسجيل)، وستُطبَّق قواعد **جهاز واحد** و**حظر الحساب** عند فتحه من جهاز آخر تلقائياً بعد تطبيق migration 029 ونشر الدالة إن لزم.

---

## ملخص سريع بالترتيب

| # | المطلوب | أين / الأمر |
|---|---------|-------------|
| 1 | بيانات المشروع (URL + anon key) | Supabase → Project Settings → API |
| 2 | تطبيق الهجرات (028–032 وغيرها) | `npx supabase db push` أو SQL Editor |
| 3 | تعيين حسابك كأدمن | `select set_admin_by_email('your@email.com');` أو تعديل `profiles.role` |
| 4 | ملفات .env في admin و mobile | نفس SUPABASE_URL و SUPABASE_ANON_KEY |
| 5 | تشغيل لوحة الأدمن | `cd apps/admin && flutter run -d chrome` |
| 6 | تشغيل تطبيق الموبايل | `cd apps/mobile && flutter run -d <جهاز>` |

إذا نفذت الخطوات بهذا الترتيب، كل من: التطبيق، لوحة الأدمن، أكواد المؤثرين، وربط الجهاز الواحد مع الحظر — سيعمل كما صُمم.

للتفاصيل الإضافية أو حل أخطاء شائعة راجع **SUPABASE_SETUP.md** في جذر المشروع.
